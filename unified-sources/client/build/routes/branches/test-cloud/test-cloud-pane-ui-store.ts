import { action, computed, observable, runInAction } from "mobx";
import { appStore } from "@root/stores";
import { ciStore } from "../../../stores/ci-store";
import { concat } from "lodash";
import { OS } from "@lib/common-interfaces";

import {
  IMsBuildSolution,
  IUITestConfigurationProperties,
  ITestCloudBranchConfigurationProperties,
  ITestProjectProperties,
} from "@root/data/build";

import { ErrorDialogUIStore } from "./error-dialog-ui-store";

export enum EnableTestsState {
  NotChangedByUser,
  Enabled,
  Disabled,
}

export enum IncompatibilityReason {
  None,
  BuiltForSimulator,
  UsesAndroidSharedRuntime,
}

/*
  Project with its textual description. Objects that implement this interface are
  displayed in the project selection drop-down.
*/
export interface ITestProjectWithDescription {
  description: string;
  project: ITestProjectProperties;
}

/*
  Generates description for a given project and returns implementation of
  ITestProjectWithDescripion.
*/
function projectWithDescription(project: ITestProjectProperties): ITestProjectWithDescription {
  let description;
  if (project.frameworkType === "Generated") {
    description = "Use tests generated by App Center";
  } else {
    const match = project.path.match(/^(.*)[/]([^/]+)/);
    if (!match) {
      description = `${project.path} (${project.frameworkType})`;
    } else {
      description = `${match[2]} (${match[1]} - ${project.frameworkType})`;
    }
  }

  return {
    description: description,
    project: project,
  };
}

export class TestCloudPaneUIStore {
  // ****************************************
  // Private members
  // ****************************************
  private generatedTestProject: ITestProjectWithDescription = projectWithDescription({
    path: "",
    frameworkType: "Generated",
    frameworkProperties: undefined,
  });

  @observable
  private _enableTestsState: EnableTestsState;
  @observable
  private _selectedProject?: ITestProjectWithDescription;
  @observable
  private _selectedUITestConfiguration: string | null = null;
  @observable
  private _isSimulatorBuild: boolean = false;
  @observable
  private _selectedXamarinSolution?: IMsBuildSolution;
  @observable
  private _selectedXamarinConfiguration?: string;
  @observable
  private _isIosSignedBuild: boolean = false;
  private _hasTestCloudFeature: boolean;

  private _errorUIStore = new ErrorDialogUIStore();

  constructor() {
    this._hasTestCloudFeature = false;
    this._enableTestsState = EnableTestsState.NotChangedByUser;
  }

  @computed
  get storedTestCloudConfig(): ITestCloudBranchConfigurationProperties | undefined {
    const currentBranchConfigurationStore = ciStore.currentRepoStore!.currentBranchConfigurationStore;
    const config = currentBranchConfigurationStore ? currentBranchConfigurationStore.data : null;

    return config && config.toolsets ? (config.toolsets.testcloud as ITestCloudBranchConfigurationProperties) : undefined;
  }

  private convertTestCloudConfigToProject(config: ITestCloudBranchConfigurationProperties): ITestProjectWithDescription {
    if (config.frameworkType === "Generated") {
      return this.generatedTestProject;
    }

    switch (config.frameworkType) {
      case "UITest":
        const uiTestProperties = config.frameworkProperties as IUITestConfigurationProperties;
        const existingProject = this.projects.find((p) => p.project.path === uiTestProperties.path);
        if (existingProject) {
          return existingProject;
        } else {
          return projectWithDescription({
            path: uiTestProperties.path,
            frameworkType: config.frameworkType,
            frameworkProperties: {
              configurations: [uiTestProperties.configuration],
            },
          });
        }

      default:
        throw new Error(`Not supported framework type: ${config.frameworkType}`);
    }
  }

  private projectSortFn(a: ITestProjectProperties, b: ITestProjectProperties): number {
    // Sort by top-level file path first
    const aLevel = a.path.split("/").length;
    const bLevel = b.path.split("/").length;
    if (aLevel !== bLevel) {
      return aLevel - bLevel;
    }
    return a.path.localeCompare(b.path);
  }

  // ****************************************
  // Public, observable properites
  // ****************************************

  @computed
  get isLoading(): boolean {
    if (!(ciStore && ciStore.currentRepoStore && ciStore.currentRepoStore.isLoaded)) {
      return true;
    }

    return !(ciStore.currentRepoStore.currentProjectsStore && ciStore.currentRepoStore.currentProjectsStore.isLoaded);
  }

  get isProjectSelectionVisible(): boolean {
    return this._hasTestCloudFeature;
  }

  @computed
  get isTestPaneEnabled(): boolean {
    if (this.isLoading) {
      return false;
    }

    return this.incompatibilityReason === IncompatibilityReason.None;
  }

  get isIos(): boolean {
    return appStore.app.os === OS.IOS;
  }

  get isIosSignedBuild(): boolean {
    return this._isIosSignedBuild;
  }

  set isIosSignedBuild(value: boolean) {
    runInAction(() => {
      this._isIosSignedBuild = value;
    });
  }

  get isSimulatorBuild(): boolean {
    return this._isSimulatorBuild;
  }

  set isSimulatorBuild(value: boolean) {
    runInAction(() => {
      this._isSimulatorBuild = value;
    });
  }

  get selectedXamarinSolution(): IMsBuildSolution | undefined {
    return this._selectedXamarinSolution;
  }

  set selectedXamarinSolution(value: IMsBuildSolution | undefined) {
    runInAction(() => {
      this._selectedXamarinSolution = value;
    });
  }

  get selectedXamarinConfiguration(): string | undefined {
    return this._selectedXamarinConfiguration;
  }

  set selectedXamarinConfiguration(value: string | undefined) {
    runInAction(() => {
      this._selectedXamarinConfiguration = value;
    });
  }

  @computed
  get enableTests(): boolean {
    if (this.incompatibilityReason !== IncompatibilityReason.None) {
      return false;
    }
    if (this._enableTestsState === EnableTestsState.NotChangedByUser) {
      return !!this.storedTestCloudConfig;
    }

    return this._enableTestsState === EnableTestsState.Enabled;
  }

  set enableTests(enable: boolean) {
    runInAction(() => {
      this._enableTestsState = enable ? EnableTestsState.Enabled : EnableTestsState.Disabled;
    });
  }

  @computed
  get usesAndroidSharedRuntime(): boolean {
    if (!(this._selectedXamarinSolution && this._selectedXamarinConfiguration)) {
      return false;
    }

    if (!(this._selectedXamarinSolution.defaultPlatform && this._selectedXamarinSolution.properties)) {
      return false;
    }

    const properties = this._selectedXamarinSolution.properties.find(
      (p) =>
        p.configuration === this._selectedXamarinConfiguration &&
        this._selectedXamarinSolution &&
        p.platform === this._selectedXamarinSolution.defaultPlatform
    );

    if (!properties) {
      return false;
    }

    return !!properties.androidUseSharedRuntime;
  }

  @computed
  get selectedProject(): ITestProjectWithDescription | undefined {
    if (this._selectedProject) {
      return this._selectedProject;
    }

    const testCloudConfig = this.storedTestCloudConfig;
    if (testCloudConfig) {
      return this.convertTestCloudConfigToProject(testCloudConfig);
    }

    return this.generatedTestProject;
  }

  set selectedProject(project: ITestProjectWithDescription | undefined) {
    runInAction(() => {
      this._selectedProject = project;
    });
  }

  @action
  public selectProjectByDescription(description: string) {
    this.selectedProject = this.projects.find((p) => p.description === description);
  }

  @computed
  get selectedUITestConfiguration(): string | null {
    if (!(this.isTestPaneEnabled && this.enableTests)) {
      return null;
    }

    if (this._selectedUITestConfiguration) {
      return this._selectedUITestConfiguration;
    }

    const testCloudConfig = this.storedTestCloudConfig;
    if (!(testCloudConfig && testCloudConfig.frameworkType === "UITest")) {
      return null;
    }

    const uiTestProperties = testCloudConfig.frameworkProperties as IUITestConfigurationProperties;

    return uiTestProperties.configuration;
  }

  set selectedUITestConfiguration(configuration: string | null) {
    runInAction(() => {
      this._selectedUITestConfiguration = configuration;
    });
  }

  @computed
  get projects(): ITestProjectWithDescription[] {
    const result = [this.generatedTestProject];
    const currentProjectStore = ciStore.currentRepoStore ? ciStore.currentRepoStore.currentProjectsStore : undefined;

    if (!(currentProjectStore && currentProjectStore.hasData)) {
      return result;
    }

    const projects = currentProjectStore.data?.testcloud?.projects;
    if (!projects) {
      return result;
    }

    return concat(
      result,
      projects.sort(this.projectSortFn).map((project) => projectWithDescription(project))
    );
  }

  @computed
  get selectedTestCloudConfig(): ITestCloudBranchConfigurationProperties | null {
    if (!this.enableTests) {
      return null;
    }

    if ((this.selectedProject && this.selectedProject.project.frameworkType === "Generated") || !this.isProjectSelectionVisible) {
      return {
        deviceSelection: "top_3_devices",
        frameworkType: "Generated",
        frameworkProperties: {},
      };
    } else if (this.selectedProject && this.selectedProject.project.frameworkType === "UITest") {
      return {
        deviceSelection: "any_top_1_device",
        frameworkType: "UITest",
        frameworkProperties: {
          path: this.selectedProject.project.path || undefined,
          configuration: this.selectedUITestConfiguration || undefined,
        },
      };
    } else {
      return null;
    }
  }

  @computed
  get incompatibilityReason(): IncompatibilityReason {
    if (this._isSimulatorBuild) {
      return IncompatibilityReason.BuiltForSimulator;
    }

    if (this.usesAndroidSharedRuntime) {
      return IncompatibilityReason.UsesAndroidSharedRuntime;
    }

    return IncompatibilityReason.None;
  }

  get errorViewModel(): ErrorDialogUIStore {
    return this._errorUIStore;
  }
}
